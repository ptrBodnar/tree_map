<!DOCTYPE html >
<html>
<head>
	<meta charset="UTF-8">
	<title>tree map</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
	  integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
	  crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
     integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
     crossorigin=""></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
     <style>
     	#mapid { height: calc(100%); width: 100%; position: absolute; z-index: -1;}

     	.mystyle { z-index: 1; background-color: grey; position: absolute; top: 30%; display: none; flex-wrap: wrap; width: 30%; overflow-y: auto; height: 40%; }

     	
     </style>

</head>
<body>
	  <div id="mapid"></div>
	  <div class="mystyle">
	  </div>	 
	 <script type="text/javascript">
	 	
	 	var mymap = L.map('mapid').setView([48.51, 32.25], 13);

	 	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
	 	    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
	 	    maxZoom: 18,
	 	    id: 'mapbox.dark',
	 	    accessToken: 'pk.eyJ1IjoicHRyYmRyIiwiYSI6ImNqZG12dWdtYzBwdzgyeHAweDFueGZrYTYifQ.ZJ2tgs6E94t3wBwFOyRSBQ'
	 	}).addTo(mymap);


	 	//Переформатувати дані, заповнити пусті поля.
	 	//Додати таблицю.
	 	//
	 	//

	 	d3.csv("cleaned_tree1.csv", function(err, data) {
	 		if (err) throw err;

	 		var nested = d3.nest()
	 		   .key(function(d) { return "" + d.Latitude + "," + d.Longitude })
	 		   .entries(data); 


	 		var color = d3.scaleLinear().domain([0,10])
	 		        .range(['#70B5DC', '#0075B4']);


			var geojson = nested.map(function(d){
			              var a = d.key.split(",");
			              return {
			              	type: "Feature",
			              	properties: d,
			              	geometry: {
			              		type: "Point",
			              		coordinates: [+a[1], +a[0]]
			              	}
			              }
			})

			geojsonLayer = L.geoJson(geojson, {
			    style: function(feature) {
			    var sumCut = 0;
			    feature.properties.values.forEach(function(d){
			    	sumCut += +d.was_cut;
			    })
			        return {color: color(sumCut)};
			    },
			    pointToLayer: function(feature, latlng) {
			    	var sumNumber = 0;
			    	feature.properties.values.forEach(function(d) {sumNumber += +d.number})

			    	if (sumNumber < 3) {
			    		sumNumber = 3;
			    	}
			    	if (sumNumber > 15){
			    		sumNumber = 15;
			    	}
			        return new L.CircleMarker(latlng, {radius: sumNumber, fillOpacity: 0.75});
			    }
			});


			mymap.addLayer(geojsonLayer);

			geojsonLayer.on("click", function (event) {
				var streets = [];
				actNumber = [];

				d3.select("div.mystyle").style("display", "flex")
			    d3.selectAll(".mystyle .element").remove();
			    
			    var element = d3.select(".mystyle")
			    	.selectAll(".element")
			    	.data(event.layer.feature.properties.values)
			    	.enter()
			    	.append("div")
			    	.attr("class", "element");


			    element.append("h4").text(function(d){
			    	if (!streets.includes(d.tree_andress_shorten)) {
			    		streets.push(d.tree_andress_shorten)
			    		return d.tree_andress_shorten
			    	}
			    })
			    element.append("h5").text(function(d){
			    	if (!actNumber.includes(d.act_number)) {
			    		actNumber.push(d.act_number)
			    		return d.act_number
			    	}
			    })
				element.append("p").text(function(d){return d.tree_characteristics + " заплановано: " + d.number + " вже зрубано: " + d.was_cut})
			});

	 	})

	 </script>
</body>
</html>